name: Playwright Tests with Xray (Simple)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
    
    - name: Run Playwright tests with JUnit reporter
      run: npx playwright test --reporter=junit
      continue-on-error: true
      env:
        PLAYWRIGHT_JUNIT_OUTPUT_NAME: xray-report.xml
    
    - name: Import results to Xray
      uses: mikepenz/xray-action@v3.1.1
      with:
        xrayCloud: true
        username: ${{ secrets.XRAY_CLIENT_ID }}
        password: ${{ secrets.XRAY_CLIENT_SECRET }}
        testFormat: "junit"
        testPaths: "xray-report.xml"
        testExecKey: ${{ secrets.XRAY_TEST_EXECUTION_KEY }}
        projectKey: ${{ secrets.JIRA_PROJECT_KEY }}
        testMerge: true
        combineInSingleTestExec: false
        failOnImportError: false
        continueOnImportError: true
        importParallelism: 2
        responseTimeout: 60000
    
    - name: Upload Playwright Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/